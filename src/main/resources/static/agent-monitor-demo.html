<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent执行监控演示 - OpenManus Java</title>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Element Plus UI Library -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    
    <!-- Element Plus Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 2.2em;
        }
        
        .header p {
            margin: 0;
            color: #6c757d;
            font-size: 1.1em;
        }
        
        .demo-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .demo-section {
            margin-bottom: 30px;
        }
        
        .demo-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .demo-description {
            color: #6c757d;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .demo-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .session-list {
            margin-top: 20px;
        }
        
        .session-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .session-status {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        .session-actions {
            display: flex;
            gap: 10px;
        }
        
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .link-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .link-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .link-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .link-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .link-description {
            font-size: 0.9em;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- 页面头部 -->
            <div class="header">
                <h1>🤖 Agent执行监控演示</h1>
                <p>测试和演示Agent执行状态监控功能</p>
            </div>
            
            <!-- 演示面板 -->
            <div class="demo-panel">
                <!-- 模拟执行演示 -->
                <div class="demo-section">
                    <div class="demo-title">
                        <el-icon><VideoPlay /></el-icon>
                        模拟Agent执行
                    </div>
                    <div class="demo-description">
                        点击下面的按钮模拟不同类型的Agent执行过程，然后在监控界面查看执行状态。
                    </div>
                    <div class="demo-actions">
                        <el-button type="primary" @click="simulateThinkDoReflect" :loading="simulating">
                            <el-icon><BrainFilled /></el-icon>
                            模拟Think-Do-Reflect流程
                        </el-button>
                        <el-button type="success" @click="simulateMultiAgent" :loading="simulating">
                            <el-icon><Connection /></el-icon>
                            模拟多Agent协作
                        </el-button>
                        <el-button type="warning" @click="simulateErrorFlow" :loading="simulating">
                            <el-icon><WarningFilled /></el-icon>
                            模拟错误处理
                        </el-button>
                    </div>
                </div>
                
                <!-- 活跃会话 -->
                <div class="demo-section">
                    <div class="demo-title">
                        <el-icon><Monitor /></el-icon>
                        活跃会话
                    </div>
                    <div class="demo-description">
                        当前正在执行或最近执行的Agent会话。
                    </div>
                    <div class="demo-actions">
                        <el-button @click="refreshActiveSessions" :loading="refreshing">
                            <el-icon><Refresh /></el-icon>
                            刷新会话列表
                        </el-button>
                        <el-button @click="clearAllSessions" type="danger" plain>
                            <el-icon><Delete /></el-icon>
                            清空所有会话
                        </el-button>
                    </div>
                    
                    <div class="session-list" v-if="activeSessions.length > 0">
                        <div v-for="(session, sessionId) in activeSessions" :key="sessionId" class="session-item">
                            <div class="session-info">
                                <div class="session-id">会话ID: {{ sessionId }}</div>
                                <div class="session-status">
                                    当前Agent: {{ getAgentDisplayName(session.agentName) }} | 
                                    状态: {{ getStatusText(session.status) }} |
                                    开始时间: {{ formatTime(session.startTime) }}
                                </div>
                            </div>
                            <div class="session-actions">
                                <el-button size="small" type="primary" @click="openMonitor(sessionId)">
                                    <el-icon><View /></el-icon>
                                    查看详情
                                </el-button>
                                <el-button size="small" type="danger" plain @click="clearSession(sessionId)">
                                    <el-icon><Delete /></el-icon>
                                    清除
                                </el-button>
                            </div>
                        </div>
                    </div>
                    
                    <div v-else-if="!refreshing" style="text-align: center; color: #6c757d; padding: 20px;">
                        暂无活跃会话
                    </div>
                </div>
                
                <!-- 快速链接 -->
                <div class="demo-section">
                    <div class="demo-title">
                        <el-icon><Link /></el-icon>
                        快速链接
                    </div>
                    <div class="quick-links">
                        <div class="link-card" @click="openPage('/agent-execution-monitor.html')">
                            <div class="link-icon">📊</div>
                            <div class="link-title">执行监控界面</div>
                            <div class="link-description">查看Agent执行状态和详细信息</div>
                        </div>
                        <div class="link-card" @click="openPage('/think-do-reflect.html')">
                            <div class="link-icon">🔄</div>
                            <div class="link-title">Think-Do-Reflect</div>
                            <div class="link-description">执行Think-Do-Reflect工作流</div>
                        </div>
                        <div class="link-card" @click="openPage('/index.html')">
                            <div class="link-icon">🏠</div>
                            <div class="link-title">主页</div>
                            <div class="link-description">返回OpenManus主页</div>
                        </div>
                        <div class="link-card" @click="openPage('/api/agent-execution/health')">
                            <div class="link-icon">❤️</div>
                            <div class="link-title">健康检查</div>
                            <div class="link-description">检查监控服务状态</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, reactive, onMounted } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            setup() {
                // 响应式数据
                const simulating = ref(false);
                const refreshing = ref(false);
                const activeSessions = ref({});
                
                // Agent类型映射
                const agentTypeMap = {
                    'supervisor': '监督者Agent',
                    'thinking_agent': '思考Agent',
                    'search_agent': '搜索Agent',
                    'code_agent': '代码Agent',
                    'file_agent': '文件Agent',
                    'reflection_agent': '反思Agent',
                    'marketplace_agent': '市场Agent',
                    'payment_agent': '支付Agent',
                    'omni_agent': '全能Agent'
                };
                
                // 状态文本映射
                const statusTextMap = {
                    'PENDING': '等待中',
                    'RUNNING': '执行中',
                    'SUCCESS': '成功',
                    'FAILED': '失败',
                    'CANCELLED': '已取消',
                    'TIMEOUT': '超时'
                };
                
                // 获取Agent显示名称
                const getAgentDisplayName = (agentName) => {
                    return agentTypeMap[agentName] || agentName;
                };
                
                // 获取状态文本
                const getStatusText = (status) => {
                    return statusTextMap[status] || status;
                };
                
                // 格式化时间
                const formatTime = (timeString) => {
                    if (!timeString) return '';
                    const date = new Date(timeString);
                    return date.toLocaleString('zh-CN');
                };
                
                // 模拟Think-Do-Reflect流程
                const simulateThinkDoReflect = async () => {
                    simulating.value = true;
                    try {
                        const response = await fetch('/api/agent-monitor-test/simulate/think-do-reflect', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                input: '分析当前AI技术发展趋势并生成简要报告'
                            })
                        });

                        const data = await response.json();

                        if (data.success && data.sessionId) {
                            ElMessage.success('Think-Do-Reflect流程模拟已启动');
                            setTimeout(() => {
                                openMonitor(data.sessionId);
                                refreshActiveSessions();
                            }, 1000);
                        } else {
                            throw new Error(data.error || '启动失败');
                        }
                    } catch (error) {
                        ElMessage.error('启动失败: ' + error.message);
                    } finally {
                        simulating.value = false;
                    }
                };
                
                // 模拟多Agent协作
                const simulateMultiAgent = async () => {
                    simulating.value = true;
                    try {
                        const response = await fetch('/api/agent-monitor-test/simulate/multi-agent', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                input: '搜索最新的机器学习论文并进行主题分析'
                            })
                        });

                        const data = await response.json();

                        if (data.success && data.sessionId) {
                            ElMessage.success('多Agent协作流程模拟已启动');
                            setTimeout(() => {
                                openMonitor(data.sessionId);
                                refreshActiveSessions();
                            }, 1000);
                        } else {
                            throw new Error(data.error || '启动失败');
                        }
                    } catch (error) {
                        ElMessage.error('启动失败: ' + error.message);
                    } finally {
                        simulating.value = false;
                    }
                };
                
                // 模拟错误处理
                const simulateErrorFlow = async () => {
                    simulating.value = true;
                    try {
                        const response = await fetch('/api/agent-monitor-test/simulate/error-flow', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                input: '执行一个会失败的任务来测试错误处理机制'
                            })
                        });

                        const data = await response.json();

                        if (data.success && data.sessionId) {
                            ElMessage.warning('错误处理流程模拟已启动');
                            setTimeout(() => {
                                openMonitor(data.sessionId);
                                refreshActiveSessions();
                            }, 1000);
                        } else {
                            throw new Error(data.error || '启动失败');
                        }
                    } catch (error) {
                        ElMessage.error('启动失败: ' + error.message);
                    } finally {
                        simulating.value = false;
                    }
                };
                
                // 刷新活跃会话
                const refreshActiveSessions = async () => {
                    refreshing.value = true;
                    try {
                        const response = await fetch('/api/agent-execution/sessions/active');
                        if (response.ok) {
                            activeSessions.value = await response.json();
                        }
                    } catch (error) {
                        ElMessage.error('刷新失败: ' + error.message);
                    } finally {
                        refreshing.value = false;
                    }
                };
                
                // 清空所有会话
                const clearAllSessions = async () => {
                    try {
                        await ElMessageBox.confirm('确定要清空所有会话数据吗？', '确认操作', {
                            type: 'warning'
                        });
                        
                        // 清空每个会话
                        for (const sessionId of Object.keys(activeSessions.value)) {
                            await fetch(`/api/agent-execution/sessions/${sessionId}`, {
                                method: 'DELETE'
                            });
                        }
                        
                        activeSessions.value = {};
                        ElMessage.success('所有会话已清空');
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('清空失败: ' + error.message);
                        }
                    }
                };
                
                // 清除单个会话
                const clearSession = async (sessionId) => {
                    try {
                        const response = await fetch(`/api/agent-execution/sessions/${sessionId}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            delete activeSessions.value[sessionId];
                            ElMessage.success('会话已清除');
                        } else {
                            throw new Error('清除失败');
                        }
                    } catch (error) {
                        ElMessage.error('清除失败: ' + error.message);
                    }
                };
                
                // 打开监控界面
                const openMonitor = (sessionId) => {
                    const monitorUrl = `/agent-execution-monitor.html?sessionId=${sessionId}`;
                    window.open(monitorUrl, '_blank');
                };
                
                // 打开页面
                const openPage = (url) => {
                    window.open(url, '_blank');
                };
                
                // 组件挂载时
                onMounted(() => {
                    refreshActiveSessions();
                });
                
                return {
                    simulating,
                    refreshing,
                    activeSessions,
                    getAgentDisplayName,
                    getStatusText,
                    formatTime,
                    simulateThinkDoReflect,
                    simulateMultiAgent,
                    simulateErrorFlow,
                    refreshActiveSessions,
                    clearAllSessions,
                    clearSession,
                    openMonitor,
                    openPage
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
